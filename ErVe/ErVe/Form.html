<!DOCTYPE html>
<html lang="fi">
<head>
    <title>ErVe lomake</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <link href="../../Content/MyStyle.css" rel="stylesheet" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function () {
            var $MaterialName = $('#materiallist');
            var $WorkName = $('#worklist');
            var $CustomerName = $('#customerlist');
            var $FormFiller = $('#formfiller');
            var $CustomerContact = $('#contact');
            var $ReadyToDate = $('#readytodate');
            var $Instructions = $('#instructions');
            var $Amount = $('#amount');
            var $PcsAmount = $('#amountpcs');
            var $ChargeFull = $('#chargefull');
            var $ChargeByPcs = $('#chargepcs');
            var $FreightCost = $('#freightcost');
            var $WorkHoursWR = $('#hourwr');
            var $WorkMinWR = $('#minwr');
            var $WorkHoursCS = $('#hourcs');
            var $WorkMinCS = $('#mincs');
            var $WorkHoursIT = $('#hourit');
            var $WorkMinIT = $('#minit');
            var $FormID = $('#formid');
            var $CreateDate = $('#createdate');

            function getCheckedMaterials() {
                var materialArray = $("#materiallist input:checked").map(function () {
                    return this.value;
                }).get();
                return materialArray.join(',');
            }

            function addCustomer(cust) {
                $CustomerName.append('<option>' + cust.CustomerName + ' </option>');
            }
            $.ajax({
                type: 'GET',
                url: '/api/customers',
                dataType: 'json',
                success: function (custs) {
                    $.each(custs, function (i, cust) {
                        addCustomer(cust);
                    });
                },
                error: function () {
                    alert: ('Virhe ladattaessa')
                }
            });

            function addWork(work) {
                $WorkName.append('<option>' + work.WorkName + ' </option>');
            }
            $.ajax({
                type: 'GET',
                url: '/api/works',
                dataType: 'json',
                success: function (works) {
                    $.each(works, function (i, work) {
                        addWork(work);
                    });
                },
                error: function () {
                    alert: ('Virhe ladattaessa')
                }
            });

            function addMaterials(material) {
                $MaterialName.append('<input type="checkbox" value="' + material.MaterialName + '">' + material.MaterialName + ' </input>');
            }
            $.ajax({
                type: 'GET',
                url: '/api/materials',
                dataType: 'json',
                success: function (materials) {
                    $.each(materials, function (i, material) {
                        addMaterials(material);
                    });
                },
                error: function () {
                    alert: ('Virhe ladattaessa')
                }
            });

            function calcHourswr() {
                var hourwr = document.getElementsByName("hourwr")[0].value * 60;
                var minwr = document.getElementsByName("minwr")[0].value;
                var sum = Number(hourwr) + Number(minwr);
                return sum;
            }

            //lomakkeen muokkaus
            if (localStorage.hasOwnProperty('key')) {
                console.log(localStorage); //testiä varten


                $(function () {
                    //tuo data localStoragesta
                    var lsdata = JSON.parse(localStorage.getItem('key'));

                        var totalMinutes = $(lsdata.WorkHoursWR);
                        //var hours = Math.floor(totalMinutes / 60);
                        //var mins = totalMinutes % 60;
                   
                    
                    console.log(totalMinutes)
                    
                    //Vie tiedot lomakkeeseen
                    $('#formid').val(lsdata.FormID);
                    $('#createdate').val(lsdata.CreateDate);
                    $('#formfiller').val(lsdata.FormFiller);
                    $('#customerlist').empty().append(lsdata.CustomerName.split(',').map(c => new Option(c, c)));
                    $('#contact').val(lsdata.CustomerContact);
                    $('#worklist').empty().append(lsdata.WorkName.split(',').map(c => new Option(c, c)));
                    $('#readytodate').val(lsdata.ReadyToDate);
                    $('#instructions').val(lsdata.Instructions);
                    $('#amount').val(lsdata.Amount);
                    $('#amountpcs').val(lsdata.PcsAmount);
                    $('#chargefull').val(lsdata.ChargeFull);
                    $('#chargepcs').val(lsdata.ChargeByPcs);
                    $('#freightcost').val(lsdata.FreightCost);

                    //var totalMinutes = $(lsdata.WorkHoursWR);
                    $('#hourwr').val(lsdata.WorkHoursWR);
                 //   $('#minwr').val(time_convert);
                    //$('#minwr').val(minutes);   

                    //   $('#materiallist').append('<input type="checkbox" checked>' + lsdata.MaterialName + ' </input>');
                    // alert(lsdata.MaterialName);
                    //var chkArray = lsdata.MaterialName.split(',');
                    //for (var i = 0; i < chkArray.length; i++) {
                    //    $('#materiallist').find('[value="' + chkArray[i] + '"]').attr('checked', true)
                    //}




                    $('#saveform').click(function (e) {
                        e.preventDefault();

                        var form = {
                            FormID: $FormID.val(),
                            FormFiller: $FormFiller.val(),
                            CustomerContact: $CustomerContact.val(),
                            ReadyToDate: $ReadyToDate.val(),
                            Instructions: $Instructions.val(),
                            Amount: $Amount.val(),
                            PcsAmount: $PcsAmount.val(),
                            ChargeFull: $ChargeFull.val(),
                            ChargeByPcs: $ChargeByPcs.val(),
                            FreightCost: $FreightCost.val(),
                            CustomerName: $CustomerName.val(),
                            WorkName: $WorkName.val(),
                            MaterialName: getCheckedMaterials(),
                            CreateDate: $CreateDate.val(),
                            WorkHoursWR: calcHourswr()
                        };

                        $.ajax({
                            method: 'put',
                            url: 'api/forms/' + form.FormID,
                            data: JSON.stringify(form),
                            contentType: 'application/json',
                            success: function () {
                                alert('Muokkaus onnistui');
                                location.reload();
                            },
                            error: function () {
                                alert('Virhe muokatessa lomaketta');
                            }
                        });
                        localStorage.removeItem('key');
                    });
                    $('#backtolist').click(function () {
                        localStorage.removeItem('key');
                    });
                });
            }
            //uusi lomake

            else {

                function getDate() {
                    var d = new Date();
                    var month = d.getMonth() + 1;
                    var day = d.getDate();
                    var year = d.getFullYear();
                    return date = year + '/' +
                        (('' + month).length < 2 ? '0' : '') + month + '/' +
                        (('' + day).length < 2 ? '0' : '') + day;
                    $('#createdate').text();
                }

                $('#saveform').click(function (e) {
                    e.preventDefault();

                    var form = {
                        CreateDate: getDate(),
                        FormFiller: $FormFiller.val(),
                        CustomerContact: $CustomerContact.val(),
                        ReadyToDate: $ReadyToDate.val(),
                        Instructions: $Instructions.val(),
                        Amount: $Amount.val(),
                        PcsAmount: $PcsAmount.val(),
                        ChargeFull: $ChargeFull.val(),
                        ChargeByPcs: $ChargeByPcs.val(),
                        FreightCost: $FreightCost.val(),
                        CustomerName: $CustomerName.val(),
                        WorkName: $WorkName.val(),
                        MaterialName: getCheckedMaterials(),
                        WorkHoursWR: calcHourswr()
                    };

                    $.ajax({
                        type: 'post',
                        url: 'api/forms',
                        data: form,
                        success: function () {

                            alert('Uusi lomake tallennettu');
                            location.reload();
                        },
                        error: function () {
                            alert('Virhe ladattaessa uutta lomaketta');
                        }
                    });
                    localStorage.removeItem('key');
                });

                $('#backtolist').click(function () {
                    localStorage.removeItem('key');
                });
            }
        });
    </script>
</head>

<body>

    <div class="container-fluid">

        <h1>ErVe</h1>

        <form class="form-horizontal">

            <div class="form-group">
                <div class="row control-label">
                    <div class="col-sm-9"><h3>*Pakollinen tieto</h3></div>
                </div>
            </div>

            <div class="form-group">
                <div class="row control-label">
                    <output class="col-xs-3" id="formid" style="color:white"></output>
                </div>
            </div>

            <div class="form-group">
                <div class="row control-label">
                    <output class="col-xs-3" typeof="date" id="createdate" style="color:white"></output>
                </div>
            </div>

            <div class="form-group">
                <label for="filler"
                       class="col-xs-3 control-label">Oma Nimi*</label>
                <div class="col-xs-7">
                    <input type="text"
                           class="form-control"
                           id="formfiller"
                           required>
                </div>
                <p class="help-block col-xs-offset-3 col-xs-7 clearfix" style="color: white">
                    Lomakkeen täyttäjän nimi
                </p>
            </div>

            <div class="form-group">
                <div class="row control-label">
                    <div class="col-xs-3 header">Laskutettavan tiedot</div>
                </div>
            </div>

            <div class="form-group">
                <label for="customer" class="col-xs-3 control-label">Yrityksen nimi*</label>
                <div class="col-xs-7">
                    <div class="dropdown">
                        <select class="btn button1" type="button" data-toggle="dropdown" id="customerlist">
                            <option>Valitse yritys</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="contact" class="col-xs-3 control-label">Yhteyshenkilö</label>
                <div class="col-xs-7">
                    <input type="text"
                           class="form-control"
                           id="contact">
                </div>
            </div>

            <div class="form-group">
                <div class="row control-label">
                    <div class="col-xs-3 header">Työ</div>
                </div>
            </div>

            <div class="form-group">
                <label for="work" class="col-xs-3 control-label">Työn nimi*</label>
                <div class="col-xs-7">
                    <div class="dropdown">
                        <select class="btn button1" type="button" data-toggle="dropdown" id="worklist">
                            <option>Valitse työ</option>
                        </select>
                    </div>
                </div>
            </div>


            <div class="form-group">
                <label for="duedate" class="col-xs-3 control-label">Viim. valmistuspvm</label>
                <div class="col-xs-7">
                    <input type="date"
                           class="form-control"
                           id="readytodate">
                </div>
            </div>


            <div class="form-group">
                <label for="directions" class="col-xs-3 control-label">Lisäohjeet</label>
                <div class="col-xs-7">
                    <textarea class="form-control" rows="7" id="instructions"></textarea>
                </div>
                <p class="help-block col-xs-offset-3 col-xs-7 clearfix" style="color: white">
                    Kirjattava kaikki tuotteet ean-numeroineen!
                </p>
            </div>

            <div class="form-group">
                <div class="row control-label">
                    <div class="col-xs-3 header">Määrä</div>
                </div>
            </div>

            <div class="form-group">
                <label for="amount" class="col-xs-3 control-label">Määrä yht.</label>
                <div class="col-xs-7">
                    <input type="text"
                           class="form-control"
                           id="amount">
                </div>
            </div>

            <div class="form-group">
                <label for="amountpcs" class="col-xs-3 control-label">Tuotekappalemäärä yht.</label>
                <div class="col-xs-7">
                    <input type="text"
                           class="form-control"
                           id="amountpcs">
                </div>
            </div>

            <div class="form-group">
                <div class="row control-label">
                    <div class="col-xs-4 header">Veloitus (Aspa täyttää jos hinta erikeen sovittu)</div>
                </div>
            </div>

            <div class="form-group">
                <label for="chargefull" class="col-xs-3 control-label">Veloitettava kokonaissumma yht.</label>
                <div class="col-xs-7">
                    <input type="text"
                           class="form-control"
                           id="chargefull">
                </div>
            </div>

            <div class="form-group">
                <label for="chargepcs" class="col-xs-3 control-label">Veloitettava kappalehinta</label>
                <div class="col-xs-7">
                    <input type="text"
                           class="form-control"
                           id="chargepcs">
                </div>
            </div>

            <div class="form-group">
                <div class="row control-label">
                    <div class="col-xs-3 header">Rahtihinta</div>
                </div>
            </div>

            <div class="form-group">
                <label for="freightCost" class="col-xs-3 control-label">Rahtihinta yht.</label>
                <div class="col-xs-7">
                    <input type="text"
                           class="form-control"
                           id="freightcost">
                </div>
            </div>

            <div class="form-group">
                <label for="material" class="col-xs-3 control-label header">Käytetyt materiaalit</label>
                <div class="col-xs-7">
                    <div class="checkbox" id="materiallist">
                        <!--<label>
                            Xpohja
                            <input type="checkbox" value="X-pohja" />
                        </label>
                        <label>
                            Tarra
                            <input type="checkbox" value="Tarra" />
                        </label>
                        <label>
                            Other
                            <input type="checkbox" value="Other" />
                        </label>-->
                    </div>
                </div>
            </div>

            <div class="form-group">
                <div class="row control-label">
                    <div class="col-xs-3 header">Käytetyt tunnit</div>
                </div>
            </div>

            <div class="form-group">
                <label for="hourswr" class="col-xs-3 control-label">Tuntityö varasto</label>
                <div class="row">
                    <div class="col-xs-7">
                        <div class="col-xs-3 form-group">
                            <input class="form-control" id="hourwr" name="hourwr" placeholder="Tunnit" type="text">
                        </div>
                        <div class="col-xs-3 form-group">
                            <input class="form-control" id="minwr" name="minwr" placeholder="Minuutit" type="text">
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="hourscs" class="col-xs-3 control-label">Tuntityö aspa</label>
                <div class="row">
                    <div class="col-xs-7">
                        <div class="col-xs-3 form-group">
                            <input class="form-control" id="hourcs" name="hourcs" placeholder="Tunnit" type="text">
                        </div>
                        <div class="col-xs-3 form-group">
                            <input class="form-control" id="mincs" name="mincs" placeholder="Minuutit" type="text">
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="hoursit" class="col-xs-3 control-label">Tuntityö IT</label>
                <div class="row">
                    <div class="col-xs-7">
                        <div class="col-xs-3 form-group">
                            <input class="form-control" id="hourit" name="hourit" placeholder="Tunnit" type="text">
                        </div>
                        <div class="col-xs-3 form-group">
                            <input class="form-control" id="minit" name="minit" placeholder="Minuutit" type="text">
                        </div>
                    </div>
                </div>
            </div>


            <div class="form-group">
                <label for="save" class="col-sm-3 control-label"></label>
                <div class="row">
                    <div class="col-sm-7">
                        <div class="col-sm-3 form-group">
                            <button type="submit" id="saveform" class="btn button1">Tallenna</button>
                        </div>
                        <div class="col-sm-3 form-group">
                            <p id="backtolist"><a href="Mainpage.html">Takaisin listaan</a></p>
                        </div>
                    </div>
                </div>
            </div>


        </form>


    </div>
</body>
</html>
