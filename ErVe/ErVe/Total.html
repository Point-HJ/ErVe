<!DOCTYPE html>
<html>
<head>
    <title>ErVe pääsivu</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <link href="../../Content/MyStyle.css" rel="stylesheet" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script>

        $(document).ajaxStart(function () {
            $("#loading").show();
        }).ajaxStop(function () {
            $("#loading").hide('slow');
        });

        //haetaan tiedot tietokannasta
        $(document).ready(function () {
            var forms = $('#forms');

            $.ajax({
                type: 'GET',
                url: 'api/Forms',
                dataType: 'json',
                success: function (data) {
                    $.each(data, function (index, val) {

                        //luodaan taulukko, johon arvot tuodaan halutuista sarakkeista
                        forms += '<tr>' +
                            "<td><a href='#'><span class='glyphicon glyphicon-pencil'></span></a></td>" +
                            "<td>" + val.FormID + "</td>" +
                            "<td>" + val.CreateDate + "</td>" +
                            "<td>" + val.FormFiller + "</td>" +
                            "<td>" + val.CustomerName + "</td>" +
                            "<td>" + val.CustomerContact + "</td>" +
                            "<td>" + val.WorkName + "</td>" +
                            "<td>" + val.ReadyToDate + "</td>" +
                            "<td>" + val.Amount + "</td>" +
                            "<td>" + val.PcsAmount + "</td>" +
                            "<td>" + val.ChargeFull + "</td>" +
                            "<td>" + val.ChargeByPcs + "</td>" +
                            "<td>" + val.Compensation + "</td>" +
                            "<td>" + val.FreightCost + "</td>" +
                            "<td>" + val.MaterialName + "</td>" +
                            "<td>" + val.WorkMinsWR + "</td>" +
                            "<td>" + val.WorkMinsIT + "</td>" +
                            "<td>" + val.WorkMinsCS + "</td>" +
                            "<td>" + val.BillReference + "</td>" +
                            "<td>" + val.StatusName + "</td>" +
                            "<td><a href='#'><span class='glyphicon glyphicon-trash'></span></a></td>" +
                            '</tr>';

                    });

                    //näytetään taulukko sivulla
                    $('#forms_table').append(forms);
                    console.log(localStorage.getItem('key')); //testiä varten

                    //  tietojen muokkaus
                    $(".glyphicon-pencil").on("click", function () {

                        // etsitään lomakkeen tiedot klikatulta riviltä
                        var FormID = $(this).parent().parent().next().text();
                        var StatusName = $(this).parent().parent().next().next().next().next().next().next().next().next().next().next().next().next().next().next().next().next().next().next().next().text();
                        if (StatusName == "Laskutettu") {
                            alert("Rivi on jo laskutettu, et voi muokata tietoja enää. Jos rivillä on virhe, ota yhteys laskutukseen.");
                        }
                        else {
                            $.ajax({
                                type: 'GET',
                                url: 'api/Forms/' + FormID,
                                dataType: 'json',
                                global: false,
                                success: function (form) {
                                    localStorage.setItem('key', JSON.stringify(form)); //Tuodaan rivin tiedot LocalStorageen
                                    var retrievedForm = localStorage.getItem('key');
                                    console.log('retrievedForm: ', JSON.parse(retrievedForm));
                                    location.href = "Form.html"; //siirrytään sivulle Form.html
                                },
                                error: function () {
                                    console.log('tietoja ei haettu');
                                },
                            });
                        }
                    });

                    // tietojen poisto
                    $(".glyphicon-trash").click(function () {
                        // etsitään lomakkeen tiedot klikatulta riviltä
                        var FormID = $(this).parent().parent().prev().prev().prev().prev().prev().prev().prev().prev().prev().prev().prev().prev().prev().prev().prev().prev().prev().prev().prev().text();
                        var StatusName = $(this).parent().parent().prev().text();
                        if (StatusName == "Laskutettu") {
                            alert("Rivi on jo laskutettu, et voi poistaa riviä. Jos rivillä on virhe, ota yhteys laskutukseen.");
                        }
                        else {
                            var ok = confirm("Haluatko varmasti poistaa lomakkeen " + FormID + "? Kaikki tiedot poistetaan tietokannasta.");
                            //Poistetaan lomake tietokannasta
                            if (ok == true) {
                                $.ajax({
                                    type: 'DELETE',
                                    url: '/api/Forms/' + FormID,
                                    contentType: 'application/json',
                                    global: false,
                                    success: function () {
                                        alert('Lomake poistettu');
                                        location.reload(); //sivun uudelleen lataus
                                    },
                                    error: function () {
                                        alert('Poisto epäonnistui')
                                    }
                                });
                            }
                        }
                    });


                },
                error: function () {
                    alert('Lataus ei onnistunut, yritä uudelleen')
                }
            });


        });
    </script>
</head>
<body>
    <div class="container-fluid">

        <h1>ErVe</h1>
        <br>
        <br>
        <br>
        <br>
        <br>
        <form class="form-horizontal">


            <div class="form-group">
                <label for="save" class="col-xs-2 control-label"></label>
                <div class="container">
                    <div class="row">
                        <div class="col-xs-3 form-group">
                            <a href="Form.html" type="submit" class="btn button1 btn-lg">Luo uusi lomake</a>
                        </div>
                        <div class="col-xs-3 form-group">
                            <a href="Index.html" type="submit" class="btn button1 btn-lg">Näytä keskeneräiset</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <div class="container-fluid">
                    <h2>Kaikki rivit</h2>
                    <table class="table table-bordered" id="forms_table">
                        <tr>
                            <th>Muokkaa</th>
                            <th>ID</th>
                            <th>Luontipäivä</th>
                            <th>Lomakkeen täyttäjä</th>
                            <th>Yritys</th>
                            <th>Yhteyshenkilö</th>
                            <th>Työn nimi</th>
                            <th>Valmistumispäivä</th>
                            <th>Määrä</th>
                            <th>Kappalemäärä</th>
                            <th>Erikseen veloitus</th>
                            <th>Erikseen veloitus/kpl</th>
                            <th>Hyvitys</th>
                            <th>Rahtikulut</th>
                            <th>Materiaalit</th>
                            <th>Varastotyö minuuteissa</th>
                            <th>IT-työ minuuteissa</th>
                            <th>Asiakaspalvelutyö minuuteissa</th>
                            <th>Viite</th>
                            <th>Status</th>
                            <th>Poista</th>
                        </tr>
                    </table>
                </div>
                <br>
                <br>
                <br>
                <div class="form-group">
                    <div class="container">
                        <div class="row col-md-8" id="loading"><h2>Lataa tietoja, odota hetki</h2></div>
                    </div>
                </div>
            </div>
        </form>
    </div>

</body>
</html>
>